<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Document</title>
<style>
*{margin:0;padding:0;border:0; box-sizing: border-box;}
body{font:14px/1.5 "Helvetica Neue", "Helvetica", "PingFang SC","Hiragino Sans GB","Microsoft YaHei","\5FAE\8F6F\96C5\9ED1","WenQuanYi Micro Hei", Arial, sans-serif; color:#333;}
ul,ol{list-style: none;}
.mb20{margin-bottom: 20px;}
.wrap{margin:20px 5%; padding: 10px; background-color:#fff;}
.tb{width: 100%; padding: 10px; border: 1px solid #ccc; margin-bottom: 15px;}
.btn{width: 100%; padding: 10px 0; color:#333; background-color: #ddd;}
.search__res-list{margin-top: 15px;}

/*!
 * Completer v0.1.3
 * https://github.com/fengyuanchen/completer
 *
 * Copyright (c) 2014-2016 Fengyuan Chen
 * Released under the MIT license
 *
 * Date: 2016-06-13T12:43:37.946Z
 */

.completer-container {
  font-family: inherit;
  font-size: 14px;
  line-height: normal;

  position: absolute;

  -webkit-box-sizing: border-box;
     -moz-box-sizing: border-box;
          box-sizing: border-box;
  margin: 0;
  padding: 0;

  list-style: none;

  border: 1px solid #ccc;
  border-bottom-color: #39f;
  background-color: #fff;
}

.completer-container li {
  overflow: hidden;

  margin: 0;
  padding: .5em .8em;

  cursor: pointer;
  white-space: nowrap;
  text-overflow: ellipsis;

  border-bottom: 1px solid #eee;
  background-color: #fff;
}

.completer-container .completer-selected,
.completer-container li:hover {
  margin-left: -1px;

  border-left: 1px solid #39f;
  background-color: #eee;
}
</style>
</head>
<body>
<div class="wrap">

<form action="./data.php" method="POST">
<div class="mb20 add__form">
	<p class="form__group">
		<input type="text" name="bike_num" id="bike_num" class="tb" placeholder="请输入id号" value="">
	</p>
	<p class="form__group">
		<input type="text" name="bike_pwd" id="bike_pwd" class="tb" placeholder="请输入密码" value="">
	</p>
	<p>
		<input type="button" class="btn" id="btn" value="提交">
	</p>
</div>
<ul id="list"></ul>
</form>

<form action="">
<div class="search__form">
	<p class="form__group">
		<input type="text" name="search" id="search" class="tb search__tb" placeholder="请输入id号" value="">
	</p>
	<p class="form__group">
		<input type="button" class="btn" id="search__btn" value="搜索">
	</p>
	<ul class="search__res-list" id="search__res-list"></ul>
</div>
</form>

</div>

<script src="//cdn.bootcss.com/jquery/3.1.0/jquery.min.js"></script>
<script src="./completer/completer.js"></script>
<script>
$(function() {
	$('#btn').on('click', function(event) {
		var $bike_num = $.trim($('#bike_num').val()),
			$bike_pwd = $.trim($('#bike_pwd').val());
		if($bike_num === '' || $bike_pwd === '') {
			alert('请输入完整的信息');return;
		} else {
			$.ajax({
				url: './data.php',
				type: 'POST',
				dataType: 'json',
				data: {bike_num: $bike_num, bike_pwd: $bike_pwd},
			})
			.done(function(data, textStatus, jqXHR) {
				console.log(data);
				$('#bike_num, #bike_pwd').val('');
				if(data.count > 0) {
					alert('添加成功！');return;
				}
			})
			.fail(function(jqXHR, textStatus, errorThrown) {
				if(jqXHR.status === 400) {
					var err = JSON.parse(jqXHR.responseText);
					console.log(err.message)
					alert(err.message);return;
				}
			})
			.always(function(jqXHR, textStatus, errorThrown) {
				console.log("complete");
			});
			
		}
	});

	/*$('#search__btn').on('click', function(event) {
		var $bike_num = $.trim($('#search').val());
		if ($bike_num) {
			$.ajax({
				url: './data.json',
				type: 'GET',
				dataType: 'json',
				data: {},
			})
			.done(function(data, textStatus, jqXHR) {
				console.log(data);
				var res = data.results,
					resId = [],
					lists = '';
				res.forEach(function(v, k) {
					resId[k] = v.id;
					if(v.id === $bike_num) {
						v.value.forEach(function(val, i) {
							lists += '<li>'+ val +'</li>';
						});
					}
				});

				if(resId.indexOf($bike_num) !== -1) {
					$('#search__res-list').html(lists);
				} else {
					$('#search__res-list').html('不存在');
				}
			})
			.fail(function(jqXHR, textStatus, errorThrown) {
				alert('网络超时！')
			});
			
		} else {
			alert('请输入id号');return;
		}
	});*/
	
	complete();
})

function complete() {
	$.ajax({
		url: './data.json',
		type: 'GET',
		dataType: 'json',
		data: {},
	})
	.done(function(data, textStatus, jqXHR) {
		console.log(data);
		var res = data.results,
			resId = [],
			resHTML = '';
		res.forEach(function(v, k) {
			resId[k] = v.id;
		});
		// 自动完成
		$("#search").completer({
			suggest: true,
			source: resId,
			complete: function(val) {
				console.log(val);
				if(resId.indexOf(val) !== -1) {
					resId.forEach(function(v, k) {
						if(v === val) {
							console.log(res[k].value)
							res[k].value.forEach(function(val, i) {
								resHTML += '<li>'+ val +'</li>';
							})
						}
					});
					$('#search__res-list').html(resHTML);
					resHTML = '';
				} else {
					$('#search__res-list').html('不存在');
				}
			}
		});
	})
	.fail(function() {
		console.log("error");
	});
	
}
</script>
</body>
</html>